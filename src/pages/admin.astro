---
// Admin page for leaderboard management
import GoogleAnalytics from '../components/GoogleAnalytics.astro';

export const prerender = false; // Needs to be dynamic for API calls
---
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard Admin</title>
    <GoogleAnalytics />
    <script src="https://cdn.tailwindcss.com" is:inline></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Lato:wght@400;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            font-family: 'Lato', sans-serif;
        }
        .admin-card {
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid #f59e0b;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }
        .delete-btn {
            transition: all 0.2s;
        }
        .delete-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
    </style>
</head>
<body class="text-slate-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="admin-card rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gold-400 font-casino">Leaderboard Admin</h1>
                <a href="/high-roller-tycoon" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-white transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Game
                </a>
            </div>

            <div id="loading" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-gold-400 text-3xl mb-4"></i>
                <p class="text-slate-400">Loading leaderboard...</p>
            </div>

            <div id="leaderboard-container" class="hidden">
                <div class="bg-black/50 rounded-lg border border-white/10 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-black/80 border-b border-white/10">
                            <tr>
                                <th class="text-left py-3 px-4 text-gold-400 font-bold">Rank</th>
                                <th class="text-left py-3 px-4 text-gold-400 font-bold">Name</th>
                                <th class="text-right py-3 px-4 text-gold-400 font-bold">Chips</th>
                                <th class="text-right py-3 px-4 text-gold-400 font-bold">Cash</th>
                                <th class="text-center py-3 px-4 text-gold-400 font-bold">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-table-body" class="divide-y divide-white/10">
                        </tbody>
                    </table>
                </div>

                <div id="empty-message" class="hidden text-center py-8 text-slate-400">
                    No entries in the leaderboard.
                </div>
            </div>

            <div id="error-message" class="hidden mt-4 p-4 bg-red-900/50 border border-red-500 rounded text-red-200">
            </div>
        </div>
    </div>

    <script is:inline>
        async function loadLeaderboard() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('leaderboard-container');
            const tableBody = document.getElementById('leaderboard-table-body');
            const emptyMsg = document.getElementById('empty-message');
            const errorMsg = document.getElementById('error-message');

            try {
                const response = await fetch('/api/leaderboard?t=' + Date.now(), {
                    cache: 'no-store'
                });
                
                if (!response.ok) throw new Error('Failed to fetch leaderboard');
                
                const leaderboard = await response.json();
                
                loading.classList.add('hidden');
                container.classList.remove('hidden');
                errorMsg.classList.add('hidden');
                
                tableBody.innerHTML = '';
                
                if (leaderboard.length === 0) {
                    emptyMsg.classList.remove('hidden');
                } else {
                    emptyMsg.classList.add('hidden');
                    leaderboard.forEach((entry, index) => {
                        const row = document.createElement('tr');
                        row.className = index % 2 === 0 ? 'bg-black/30' : '';
                        
                        row.innerHTML = `
                            <td class="py-3 px-4 font-bold ${index === 0 ? 'text-gold-400' : index === 1 ? 'text-slate-300' : index === 2 ? 'text-amber-600' : 'text-slate-400'}">
                                #${index + 1}
                            </td>
                            <td class="py-3 px-4 text-slate-200 font-bold">${entry.name || 'Anonymous'}</td>
                            <td class="py-3 px-4 text-right font-mono text-gold-400 font-bold">${formatNumber(entry.chips || 0)}</td>
                            <td class="py-3 px-4 text-right font-mono text-green-400 font-bold">$${formatNumber(entry.cash || 0)}</td>
                            <td class="py-3 px-4 text-center">
                                <button 
                                    onclick="deleteEntry('${entry.name}', ${index})"
                                    class="delete-btn px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-bold transition-all"
                                >
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                loading.classList.add('hidden');
                container.classList.add('hidden');
                errorMsg.classList.remove('hidden');
                errorMsg.textContent = 'Failed to load leaderboard. Please try again.';
            }
        }

        async function deleteEntry(name, index) {
            if (!confirm(`Are you sure you want to delete "${name}" from the leaderboard?`)) {
                return;
            }

            try {
                const response = await fetch('/api/leaderboard', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete entry');
                }

                // Reload the leaderboard
                await loadLeaderboard();
                
                // Show success message
                const errorMsg = document.getElementById('error-message');
                errorMsg.classList.remove('hidden', 'bg-red-900/50', 'border-red-500', 'text-red-200');
                errorMsg.classList.add('bg-green-900/50', 'border-green-500', 'text-green-200');
                errorMsg.textContent = `Successfully deleted "${name}" from the leaderboard.`;
                
                setTimeout(() => {
                    errorMsg.classList.add('hidden');
                }, 3000);
            } catch (error) {
                console.error('Error deleting entry:', error);
                const errorMsg = document.getElementById('error-message');
                errorMsg.classList.remove('hidden');
                errorMsg.textContent = `Failed to delete entry: ${error.message}`;
            }
        }

        function formatNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'k';
            return Math.floor(num).toLocaleString();
        }

        // Load leaderboard on page load
        window.addEventListener('DOMContentLoaded', loadLeaderboard);
    </script>
</body>
</html>

